<!doctype html>
<head>
  <meta charset="utf-8">
  <title>Proyecto: Vida Electrónica :: Eloquent JavaScript</title>
  <link rel=stylesheet href="js/node_modules/codemirror/lib/codemirror.css">
  <script src="js/acorn_codemirror.js"></script>
  <link rel=stylesheet href="css/ejs.css">
  <script src="js/sandbox.js"></script>
  <script src="js/ejs.js"></script>
  <script>var chapNum = 7;var sandboxLoadFiles = ["code/chapter/07_elife.js", "code/animateworld.js"];</script>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-53624335-3', 'auto');
  ga('send', 'pageview');

  </script>
</head>

<article>
<nav>
  <a href="06_object.html" title="capítulo previo">◀</a>
  <a href="index.html" title="cover">◆</a>
  <a href="08_error.html" title="capítulo siguiente">▶</a>
</nav>

<h1><div class=chap_num>Capítulo 7</div>Proyecto: Vida Electrónica</h1>
<blockquote>
<p><a class=p_ident id="p_hsF7HXJVwW" href="#p_hsF7HXJVwW"></a>[...] La pregunta de si las máquinas pueden pensar [...] es tan relevante como la pregunta de si los submarinos pueden nadar.</p>
 <footer>Edsger Dijkstra, <cite>The Threats to Computing Science</cite></footer>
</blockquote>
<p><a class=p_ident id="p_L36FChdJsI" href="#p_L36FChdJsI"></a>In “project” chapters,
En los capítulos de proyecto, dejaré de abrumarte con teoría nueva por un breve momento, y en lugar de eso trabajaremos a través de un programa juntos. La teoría es indispensable cuando aprendemos a programar, pero debería ser acompañada de lecturas y la comprensión de programas no triviales.</p>
<p><a class=p_ident id="p_4pEjZEjFmh" href="#p_4pEjZEjFmh"></a>Nuestro proyecto en este capítulo es construir un ecosistema virtual, un mundo pequeño poblado con bichos que se mueven alrededor y luchan por sobrevivir.</p>
<h2><a class=h_ident id="h_iJKz2yzui1" href="#h_iJKz2yzui1"></a>Definición</h2>
<p><a class=p_ident id="p_D4d5uu+bxy" href="#p_D4d5uu+bxy"></a>Para hacer esta tarea manejable, nosotros simplificaremos radicalmente el concepto de mundo (<em>world</em>). Es decir un mundo será una cuadricula de dos dimensiones donde cada entidad ocupa un cuadro completo de ella. En cada <em>turn</em>, todos los bichos tienen oportunidad de hacer alguna acción.</p>
<p><a class=p_ident id="p_X4lDDIm/al" href="#p_X4lDDIm/al"></a>Por lo tanto, cortamos ambos tiempo y espacio en dos unidades con un tamaño fijo: cuadros para espacio y turnos para tiempo. Por supuesto, esto es una burda e imprecisa aproximación. Pero nuestra simulación pretende ser entretenida, no precisa, así que podemos acortar libremente las dimensiones.</p>
<p id="plan"><a class=p_ident id="p_tAGUlZAWCH" href="#p_tAGUlZAWCH"></a>Podemos definir un mundo como un <em>plan</em>, una matriz de cadenas que establece la cuadrícula del mundo usando un carácter por cuadro. .</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_YSHh4Dww1G" href="#c_YSHh4Dww1G"></a><span class="cm-keyword">var</span> <span class="cm-variable">plan</span> <span class="cm-operator">=</span> [<span class="cm-string">"############################"</span>,
            <span class="cm-string">"#      #    #      o      ##"</span>,
            <span class="cm-string">"#                          #"</span>,
            <span class="cm-string">"#          #####           #"</span>,
            <span class="cm-string">"##         #   #    ##     #"</span>,
            <span class="cm-string">"###           ##     #     #"</span>,
            <span class="cm-string">"#           ###      #     #"</span>,
            <span class="cm-string">"#   ####                   #"</span>,
            <span class="cm-string">"#   ##       o             #"</span>,
            <span class="cm-string">"# o  #         o       ### #"</span>,
            <span class="cm-string">"#    #                     #"</span>,
            <span class="cm-string">"############################"</span>];</pre>
<p><a class=p_ident id="p_28avajbfy9" href="#p_28avajbfy9"></a>El carácter "#" en este programa representa paredes y rocas, y el carácter "o" representa bichos (<em>critters</em>). Los espacios, como posiblemente habrás adivinado, son espacios vacíos.</p>
<p><a class=p_ident id="p_PhBguL18VP" href="#p_PhBguL18VP"></a>Una matriz unidimensional puede ser usada para crear un objeto mundo (<em>world</em>). Tal objeto mantiene seguimiento del tamaño y el contenido. El mundo tiene un método <em>toString</em> que convierte al mundo nuevamente en una cadena imprimible (parecida al programa en el que se basó) de manera que podamos ver qué es lo que está pasando dentro. El objeto mundo también tiene un método <em>turn</em>, el cual permite a todos los bichos que lo habitan tomar un turno y luego actualizar el mundo reflejando sus acciones.</p>
<h2 id="grid"><a class=h_ident id="h_XSOvrYsG/b" href="#h_XSOvrYsG/b"></a>Representando el espacio.</h2>
<p><a class=p_ident id="p_K/BxnLCCNj" href="#p_K/BxnLCCNj"></a>La cuadrícula (<em>grid</em>) que modela el mundo tiene un ancho y altura fija. Los cuadros son identificados por sus coordenadas "X" y "Y". Usamos un tipo sencillo, <em>Vector</em> (como los vistos en los ejercicios del <a href="06_object.html#exercise_vector">capítulo anterior</a>), para representar estas coordenadas en pares.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_mciWzOsKpc" href="#c_mciWzOsKpc"></a><span class="cm-keyword">function</span> <span class="cm-variable">Vector</span>(<span class="cm-def">x</span>, <span class="cm-def">y</span>) {
  <span class="cm-keyword">this</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">x</span>;
  <span class="cm-keyword">this</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">y</span>;
}
<span class="cm-variable">Vector</span>.<span class="cm-property">prototype</span>.<span class="cm-property">plus</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">other</span>) {
  <span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>(<span class="cm-keyword">this</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">other</span>.<span class="cm-property">x</span>, <span class="cm-keyword">this</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">other</span>.<span class="cm-property">y</span>);
};</pre>
<p><a class=p_ident id="p_9w6wm7z2Qx" href="#p_9w6wm7z2Qx"></a> A continuacion, necesitamos un tipo de objeto que modele por si mismo la cuadricula (<em>grid</em>). La cuadricula es parte del mundo, pero nosotros estamos haciendo la cuadricula como un objeto separado (que sera una propiedad del objeto mundo) para mantener el objeto <em>world</em> simple. El mundo debe ocuparse de las cosas relacionadas con el mundo, y la cuadricula debe ocuparse de las cosas relacionadas con la cuadricula.</p>
<p><a class=p_ident id="p_x3GgncC/mM" href="#p_x3GgncC/mM"></a>Para almacenar una cuadricula de valores, tenemos varias opciones. Podemos utilizar una matriz de matrices de filas (<em>array of row arrays</em>) y utilizar dos propiedades de acceso para llegar a una cruadricula específica:</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_Voq/ROrLo4" href="#c_Voq/ROrLo4"></a><span class="cm-keyword">var</span> <span class="cm-variable">grid</span> <span class="cm-operator">=</span> [[<span class="cm-string">"top left"</span>,    <span class="cm-string">"top middle"</span>,    <span class="cm-string">"top right"</span>],
            [<span class="cm-string">"bottom left"</span>, <span class="cm-string">"bottom middle"</span>, <span class="cm-string">"bottom right"</span>]];
<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">grid</span>[<span class="cm-number">1</span>][<span class="cm-number">2</span>]);
<span class="cm-comment">// → bottom right</span></pre>
<p><a class=p_ident id="p_U2oTVcUfFf" href="#p_U2oTVcUfFf"></a>O podemos utilizar una sola matriz, con el tamaño de ancho x alto, y decidir que el elemento en (<em>x</em>,<em>y</em>) se encuentra en la posición <em>x</em> + (<em>y</em> x ancho) de la matriz.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_TYOgAj5b50" href="#c_TYOgAj5b50"></a><span class="cm-keyword">var</span> <span class="cm-variable">grid</span> <span class="cm-operator">=</span> [<span class="cm-string">"top left"</span>,    <span class="cm-string">"top middle"</span>,    <span class="cm-string">"top right"</span>,
            <span class="cm-string">"bottom left"</span>, <span class="cm-string">"bottom middle"</span>, <span class="cm-string">"bottom right"</span>];
<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">grid</span>[<span class="cm-number">2</span> <span class="cm-operator">+</span> (<span class="cm-number">1</span> <span class="cm-operator">*</span> <span class="cm-number">3</span>)]);
<span class="cm-comment">// → bottom right</span></pre>
<p><a class=p_ident id="p_xa3398J8rw" href="#p_xa3398J8rw"></a>Dado que el acceso real a esta matriz (<em>Array</em>) será envuelto en métodos en el objeto de tipo cuadricula, no le importa al código externo cual enfoque tomamos. Elegí la segunda representación, ya que hace que sea mucho más fácil crear la matriz. Al llamar al constructor de <em>Array</em> con un solo número como argumento, se crea una nueva matriz vacía de la longitud dada.</p>
<p><a class=p_ident id="p_6bzwsfcnmW" href="#p_6bzwsfcnmW"></a>Este código define el objeto cuadricula (<em>Grid</em>) con algunos métodos básicos:</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_ygwzXGZzJU" href="#c_ygwzXGZzJU"></a><span class="cm-keyword">function</span> <span class="cm-variable">Grid</span>(<span class="cm-def">width</span>, <span class="cm-def">height</span>) {
  <span class="cm-keyword">this</span>.<span class="cm-property">space</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Array</span>(<span class="cm-variable-2">width</span> <span class="cm-operator">*</span> <span class="cm-variable-2">height</span>);
  <span class="cm-keyword">this</span>.<span class="cm-property">width</span> <span class="cm-operator">=</span> <span class="cm-variable-2">width</span>;
  <span class="cm-keyword">this</span>.<span class="cm-property">height</span> <span class="cm-operator">=</span> <span class="cm-variable-2">height</span>;
}
<span class="cm-variable">Grid</span>.<span class="cm-property">prototype</span>.<span class="cm-property">isInside</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">vector</span>) {
  <span class="cm-keyword">return</span> <span class="cm-variable-2">vector</span>.<span class="cm-property">x</span> <span class="cm-operator">>=</span> <span class="cm-number">0</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable-2">vector</span>.<span class="cm-property">x</span> <span class="cm-operator">&lt;</span> <span class="cm-keyword">this</span>.<span class="cm-property">width</span> <span class="cm-operator">&amp;&amp;</span>
         <span class="cm-variable-2">vector</span>.<span class="cm-property">y</span> <span class="cm-operator">>=</span> <span class="cm-number">0</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable-2">vector</span>.<span class="cm-property">y</span> <span class="cm-operator">&lt;</span> <span class="cm-keyword">this</span>.<span class="cm-property">height</span>;
};
<span class="cm-variable">Grid</span>.<span class="cm-property">prototype</span>.<span class="cm-property">get</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">vector</span>) {
  <span class="cm-keyword">return</span> <span class="cm-keyword">this</span>.<span class="cm-property">space</span>[<span class="cm-variable-2">vector</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-keyword">this</span>.<span class="cm-property">width</span> <span class="cm-operator">*</span> <span class="cm-variable-2">vector</span>.<span class="cm-property">y</span>];
};
<span class="cm-variable">Grid</span>.<span class="cm-property">prototype</span>.<span class="cm-property">set</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">vector</span>, <span class="cm-def">value</span>) {
  <span class="cm-keyword">this</span>.<span class="cm-property">space</span>[<span class="cm-variable-2">vector</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-keyword">this</span>.<span class="cm-property">width</span> <span class="cm-operator">*</span> <span class="cm-variable-2">vector</span>.<span class="cm-property">y</span>] <span class="cm-operator">=</span> <span class="cm-variable-2">value</span>;
};</pre>
<p><a class=p_ident id="p_MmMEgUJe7X" href="#p_MmMEgUJe7X"></a>Y aquí es una prueba trivial:</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_T3JuS8ULpT" href="#c_T3JuS8ULpT"></a><span class="cm-keyword">var</span> <span class="cm-variable">grid</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Grid</span>(<span class="cm-number">5</span>, <span class="cm-number">5</span>);
<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">grid</span>.<span class="cm-property">get</span>(<span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>(<span class="cm-number">1</span>, <span class="cm-number">1</span>)));
<span class="cm-comment">// → undefined</span>
<span class="cm-variable">grid</span>.<span class="cm-property">set</span>(<span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>(<span class="cm-number">1</span>, <span class="cm-number">1</span>), <span class="cm-string">"X"</span>);
<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">grid</span>.<span class="cm-property">get</span>(<span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>(<span class="cm-number">1</span>, <span class="cm-number">1</span>)));
<span class="cm-comment">// → X</span></pre>
<h2><a class=h_ident id="h_sbR2Tl3UOe" href="#h_sbR2Tl3UOe"></a>Una interfaz para programar bichos (<em>critter</em>)</h2>
<p><a class=p_ident id="p_yrw7ANqcgf" href="#p_yrw7ANqcgf"></a>Antes de que podamos comenzar con nuestro <em>constructor</em> en nuestro mundo, debemos obtener más especificaciones sobre los objetos <em>critter</em> que estarán viviendo dentro de él. Mencioné que el mundo preguntará a las criaturas qué acciones quieren tomar. Esto funciona de esta manera: cada objeto <em>critter</em> tiene un método <em>act</em> que, cuando se lo llama, devuelve una acción. Una acción es un objeto con una propiedad de tipo (<em>type</em>), que indica el tipo de acción que el <em>critter</em> quiere tomar, por ejemplo "mover". La acción también puede contener información adicional, como la dirección en la que el <em>critter</em> quiere moverse.</p>
<p id="directions"><a class=p_ident id="p_FvBENAWp3m" href="#p_FvBENAWp3m"></a>Los <em>Critters</em> son terriblemente miopes y pueden ver solamente los cuadrados directamente alrededor de ellos en la cuadricula. Pero incluso esta visión limitada puede ser útil al decidir qué acción tomar. Cuando se llama al método <em>act</em>, se recibe un objeto <em>view</em> que permite al <em>critter</em> inspeccionar su entorno. Nombramos los ocho cuadrados circundantes por sus direcciones de la brújula: "<em>n</em>" para el norte, "<em>ne</em>" para el noreste, y así sucesivamente. Este es el objeto que usaremos para asignar los nombres de dirección a los desplazamientos de coordenadas:</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_c47GSqHmYK" href="#c_c47GSqHmYK"></a><span class="cm-keyword">var</span> <span class="cm-variable">directions</span> <span class="cm-operator">=</span> {
  <span class="cm-string cm-property">"n"</span>:  <span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>( <span class="cm-number">0</span>, <span class="cm-operator">-</span><span class="cm-number">1</span>),
  <span class="cm-string cm-property">"ne"</span>: <span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>( <span class="cm-number">1</span>, <span class="cm-operator">-</span><span class="cm-number">1</span>),
  <span class="cm-string cm-property">"e"</span>:  <span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>( <span class="cm-number">1</span>,  <span class="cm-number">0</span>),
  <span class="cm-string cm-property">"se"</span>: <span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>( <span class="cm-number">1</span>,  <span class="cm-number">1</span>),
  <span class="cm-string cm-property">"s"</span>:  <span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>( <span class="cm-number">0</span>,  <span class="cm-number">1</span>),
  <span class="cm-string cm-property">"sw"</span>: <span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>(<span class="cm-operator">-</span><span class="cm-number">1</span>,  <span class="cm-number">1</span>),
  <span class="cm-string cm-property">"w"</span>:  <span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>(<span class="cm-operator">-</span><span class="cm-number">1</span>,  <span class="cm-number">0</span>),
  <span class="cm-string cm-property">"nw"</span>: <span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>(<span class="cm-operator">-</span><span class="cm-number">1</span>, <span class="cm-operator">-</span><span class="cm-number">1</span>)
};</pre>
<p><a class=p_ident id="p_i98u5dly+3" href="#p_i98u5dly+3"></a>El objeto <em>view</em> tiene un método <em>look</em>, que toma una dirección y devuelve un carácter, por ejemplo "<em></em>" cuando hay una pared en esa dirección, o " " (espacio) cuando no hay nada allí. El objeto también proporciona los métodos convenientes <em>find</em> y <em>findAll</em>. Ambos toman un carácter de mapa como argumento. El primero devuelve una dirección en la que el carácter se puede encontrar con respecto al <em>critter</em> o devuelve <em>null</em> si no existe tal dirección. El segundo devuelve una matriz que contiene todas las direcciones con ese carácter. Por ejemplo, una criatura sentada a la izquierda (al oeste) de una pared obtendrá ["<em>ne</em>", "<em>e</em>", "<em>se</em>"] al llamar a <em>findAll</em> en su objeto de vista con el carácter "<em></em>" como argumento.</p>
<p><a class=p_ident id="p_LiBmgIme6y" href="#p_LiBmgIme6y"></a>Aquí está un <em>critter</em> simple y estúpido que sigue su nariz hasta que golpea un obstáculo y luego rebota en una dirección al azar:</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_DFH+MZaTtO" href="#c_DFH+MZaTtO"></a><span class="cm-keyword">function</span> <span class="cm-variable">randomElement</span>(<span class="cm-def">array</span>) {
  <span class="cm-keyword">return</span> <span class="cm-variable-2">array</span>[<span class="cm-variable">Math</span>.<span class="cm-property">floor</span>(<span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">*</span> <span class="cm-variable-2">array</span>.<span class="cm-property">length</span>)];
}

<span class="cm-keyword">var</span> <span class="cm-variable">directionNames</span> <span class="cm-operator">=</span> <span class="cm-string">"n ne e se s sw w nw"</span>.<span class="cm-property">split</span>(<span class="cm-string">" "</span>);

<span class="cm-keyword">function</span> <span class="cm-variable">BouncingCritter</span>() {
  <span class="cm-keyword">this</span>.<span class="cm-property">direction</span> <span class="cm-operator">=</span> <span class="cm-variable">randomElement</span>(<span class="cm-variable">directionNames</span>);
};

<span class="cm-variable">BouncingCritter</span>.<span class="cm-property">prototype</span>.<span class="cm-property">act</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">view</span>) {
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">view</span>.<span class="cm-property">look</span>(<span class="cm-keyword">this</span>.<span class="cm-property">direction</span>) <span class="cm-operator">!=</span> <span class="cm-string">" "</span>)
    <span class="cm-keyword">this</span>.<span class="cm-property">direction</span> <span class="cm-operator">=</span> <span class="cm-variable-2">view</span>.<span class="cm-property">find</span>(<span class="cm-string">" "</span>) <span class="cm-operator">||</span> <span class="cm-string">"s"</span>;
  <span class="cm-keyword">return</span> {<span class="cm-property">type</span>: <span class="cm-string">"move"</span>, <span class="cm-property">direction</span>: <span class="cm-keyword">this</span>.<span class="cm-property">direction</span>};
};</pre>
<p><a class=p_ident id="p_UUmVtnidxV" href="#p_UUmVtnidxV"></a>La función de ayuda <em>randomElement</em> simplemente selecciona un elemento aleatorio de una matriz (<em>Array</em>), usando <em>Math.random</em> más algún cálculo aritmético obtendremos un índice aleatorio. Esto lo usaremos más adelante porque la aleatoriedad puede ser útil en simulaciones.</p>
<p><a class=p_ident id="p_OdtJi5iJMY" href="#p_OdtJi5iJMY"></a>Para escoger una dirección aleatoria, el constructor <em>BouncingCritter</em> llama a <em>randomElement</em> en una matriz <em>directionNames</em>. También podríamos haber usado <em>Object.keys</em> para obtener esta matriz del objeto <em>directions</em> que definimos anteriormente, pero eso no proporciona garantías sobre el orden en el que se enumeran las propiedades. En la mayoría de las situaciones, los motores de JavaScript modernos devolverán las propiedades en el orden en que se definieron, pero no necesariamente.</p>
<p><a class=p_ident id="p_PauzgL/qeY" href="#p_PauzgL/qeY"></a>El “<code>|| "S"</code>” en el método <em>act</em> está ahí para evitar que <em>this.direction</em> de valor <em>null</em> si el <em>critter</em> está de alguna manera atrapado sin espacio vacío alrededor de él (por ejemplo, cuando se aglomeran en una esquina con otros <em>critters</em>).</p>
<h2><a class=h_ident id="h_PesTBcS/2F" href="#h_PesTBcS/2F"></a>El objeto del mundo</h2>
<p><a class=p_ident id="p_8k9zNzFYh5" href="#p_8k9zNzFYh5"></a>Ahora podemos comenzar con el tipo de objeto <em>World</em>. El constructor toma un plan (la matriz de cadenas que representa la cuadrícula del mundo, <a href="07_elife.html#grid">descrita</a> anteriormente) y una leyenda (<em>legend</em>) como argumentos. Una leyenda es un objeto que nos dice qué significa cada carácter en el mapa. Contiene un constructor para cada carácter, excepto el carácter de espacio, que siempre refiere a <em>null</em> y es el valor que usaremos para representar el espacio vacío.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_p2N2N4tOq2" href="#c_p2N2N4tOq2"></a><span class="cm-keyword">function</span> <span class="cm-variable">elementFromChar</span>(<span class="cm-def">legend</span>, <span class="cm-def">ch</span>) {
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">ch</span> <span class="cm-operator">==</span> <span class="cm-string">" "</span>)
    <span class="cm-keyword">return</span> <span class="cm-atom">null</span>;
  <span class="cm-keyword">var</span> <span class="cm-def">element</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable-2">legend</span>[<span class="cm-variable-2">ch</span>]();
  <span class="cm-variable-2">element</span>.<span class="cm-property">originChar</span> <span class="cm-operator">=</span> <span class="cm-variable-2">ch</span>;
  <span class="cm-keyword">return</span> <span class="cm-variable-2">element</span>;
}

<span class="cm-keyword">function</span> <span class="cm-variable">World</span>(<span class="cm-def">map</span>, <span class="cm-def">legend</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">grid</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Grid</span>(<span class="cm-variable-2">map</span>[<span class="cm-number">0</span>].<span class="cm-property">length</span>, <span class="cm-variable-2">map</span>.<span class="cm-property">length</span>);
  <span class="cm-keyword">this</span>.<span class="cm-property">grid</span> <span class="cm-operator">=</span> <span class="cm-variable-2">grid</span>;
  <span class="cm-keyword">this</span>.<span class="cm-property">legend</span> <span class="cm-operator">=</span> <span class="cm-variable-2">legend</span>;

  <span class="cm-variable-2">map</span>.<span class="cm-property">forEach</span>(<span class="cm-keyword">function</span>(<span class="cm-def">line</span>, <span class="cm-def">y</span>) {
    <span class="cm-keyword">for</span> (<span class="cm-keyword">var</span> <span class="cm-def">x</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">x</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">line</span>.<span class="cm-property">length</span>; <span class="cm-variable-2">x</span><span class="cm-operator">++</span>)
      <span class="cm-variable-2">grid</span>.<span class="cm-property">set</span>(<span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>(<span class="cm-variable-2">x</span>, <span class="cm-variable-2">y</span>),
               <span class="cm-variable">elementFromChar</span>(<span class="cm-variable-2">legend</span>, <span class="cm-variable-2">line</span>[<span class="cm-variable-2">x</span>]));
  });
}</pre>
<p><a class=p_ident id="p_Te2f+m8Ngj" href="#p_Te2f+m8Ngj"></a>En <em>elementFromChar</em>, primero creamos una <em>instance</em> del tipo correcto buscando el constructor del carácter y aplicándole <em>new</em>. A continuación, agregamos una propiedad <em>originChar</em> a ella para que sea fácil averiguar de qué carácter se creó el elemento originalmente.</p>
<p><a class=p_ident id="p_cegiUstqom" href="#p_cegiUstqom"></a>Necesitamos esta propiedad <em>originChar</em> al implementar el método <em>toString</em> de <em>word</em>. Este método construye una cadena <em>maplike</em> del estado actual del mundo realizando un bucle bidimensional sobre los cuadros de la cuadrícula.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_eUl3+53vHg" href="#c_eUl3+53vHg"></a><span class="cm-keyword">function</span> <span class="cm-variable">charFromElement</span>(<span class="cm-def">element</span>) {
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">element</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>)
    <span class="cm-keyword">return</span> <span class="cm-string">" "</span>;
  <span class="cm-keyword">else</span>
    <span class="cm-keyword">return</span> <span class="cm-variable-2">element</span>.<span class="cm-property">originChar</span>;
}

<span class="cm-variable">World</span>.<span class="cm-property">prototype</span>.<span class="cm-property">toString</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>() {
  <span class="cm-keyword">var</span> <span class="cm-def">output</span> <span class="cm-operator">=</span> <span class="cm-string">""</span>;
  <span class="cm-keyword">for</span> (<span class="cm-keyword">var</span> <span class="cm-def">y</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">y</span> <span class="cm-operator">&lt;</span> <span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">height</span>; <span class="cm-variable-2">y</span><span class="cm-operator">++</span>) {
    <span class="cm-keyword">for</span> (<span class="cm-keyword">var</span> <span class="cm-def">x</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">x</span> <span class="cm-operator">&lt;</span> <span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">width</span>; <span class="cm-variable-2">x</span><span class="cm-operator">++</span>) {
      <span class="cm-keyword">var</span> <span class="cm-def">element</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">get</span>(<span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>(<span class="cm-variable-2">x</span>, <span class="cm-variable-2">y</span>));
      <span class="cm-variable-2">output</span> <span class="cm-operator">+=</span> <span class="cm-variable">charFromElement</span>(<span class="cm-variable-2">element</span>);
    }
    <span class="cm-variable-2">output</span> <span class="cm-operator">+=</span> <span class="cm-string">"\n"</span>;
  }
  <span class="cm-keyword">return</span> <span class="cm-variable-2">output</span>;
};</pre>
<p><a class=p_ident id="p_Ei2YG76UGr" href="#p_Ei2YG76UGr"></a>Una pared es un objeto simple: se usa sólo para ocupar espacio y no tiene método <em>act</em>.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_ouajOZJ4Gg" href="#c_ouajOZJ4Gg"></a><span class="cm-keyword">function</span> <span class="cm-variable">Wall</span>() {}</pre>
<p><a class=p_ident id="p_EKQQX55Ad8" href="#p_EKQQX55Ad8"></a>Cuando probamos el objeto <em>World</em> creando una instancia basada en el plan del <a href="07_elife.html#plan">capítulo anterior</a> y luego invocando <em>toString</em> sobre él, obtenemos una cadena muy similar al plan.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_4XkG2wJR1P" href="#c_4XkG2wJR1P"></a><span class="cm-keyword">var</span> <span class="cm-variable">world</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">World</span>(<span class="cm-variable">plan</span>, {<span class="cm-string cm-property">"#"</span>: <span class="cm-variable">Wall</span>,
                             <span class="cm-string cm-property">"o"</span>: <span class="cm-variable">BouncingCritter</span>});
<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">world</span>.<span class="cm-property">toString</span>());
<span class="cm-comment">// → ############################</span>
<span class="cm-comment">//   #      #    #      o      ##</span>
<span class="cm-comment">//   #                          #</span>
<span class="cm-comment">//   #          #####           #</span>
<span class="cm-comment">//   ##         #   #    ##     #</span>
<span class="cm-comment">//   ###           ##     #     #</span>
<span class="cm-comment">//   #           ###      #     #</span>
<span class="cm-comment">//   #   ####                   #</span>
<span class="cm-comment">//   #   ##       o             #</span>
<span class="cm-comment">//   # o  #         o       ### #</span>
<span class="cm-comment">//   #    #                     #</span>
<span class="cm-comment">//   ############################</span></pre>
<h2><a class=h_ident id="h_FwCYhL5q4u" href="#h_FwCYhL5q4u"></a><em>This</em> y su alcance</h2>
<p><a class=p_ident id="p_8ZARq2B+ts" href="#p_8ZARq2B+ts"></a>El constructor <em>World</em> contiene una llamada a <em>forEach</em>. Una cosa interesante a notar es que dentro de la función pasada a <em>forEach</em> ya no estamos directamente en el ámbito de funciones del <em>constructor</em>. Cada llamada de función obtiene su propia vinculación para <em>this</em>, por lo que el <em>this</em> en la función interna no se refiere al mismo objeto en la­ nueva construcción que se refiere <em>this</em> en la funcion externa.  De hecho, cuando una función no se llama como un (método), <em>this</em> hará referencia al objeto global.</p>
<p><a class=p_ident id="p_vFLSMTu5sr" href="#p_vFLSMTu5sr"></a>Esto significa que no podemos escribir <em>this.grid</em> para acceder a la cuadrícula desde dentro del bucle. En su lugar, la función externa crea una variable local normal, <em>grid</em>, a través de la cual la función interna obtiene acceso a la cuadrícula.</p>
<p><a class=p_ident id="p_xVBdtoqMgN" href="#p_xVBdtoqMgN"></a>Esto es un poco un error de diseño en JavaScript. Afortunadamente, la siguiente versión del lenguaje proporciona una solución para este problema. Mientras tanto, hay soluciones. Un patrón común es decir <em>var self = this</em> y a partir de entonces se refiere a <em>self</em>, que es una variable normal y, por lo tanto, visible a las funciones internas.</p>
<p><a class=p_ident id="p_WWIX081hTG" href="#p_WWIX081hTG"></a>Otra solución es utilizar el método <em>bind</em>, que nos permite proporcionar un objeto explícito a enlazar.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_tfOfTKwHwy" href="#c_tfOfTKwHwy"></a><span class="cm-keyword">var</span> <span class="cm-variable">test</span> <span class="cm-operator">=</span> {
  <span class="cm-property">prop</span>: <span class="cm-number">10</span>,
  <span class="cm-property">addPropTo</span>: <span class="cm-keyword">function</span>(<span class="cm-def">array</span>) {
    <span class="cm-keyword">return</span> <span class="cm-variable-2">array</span>.<span class="cm-property">map</span>(<span class="cm-keyword">function</span>(<span class="cm-def">elt</span>) {
      <span class="cm-keyword">return</span> <span class="cm-keyword">this</span>.<span class="cm-property">prop</span> <span class="cm-operator">+</span> <span class="cm-variable-2">elt</span>;
    }.<span class="cm-property">bind</span>(<span class="cm-keyword">this</span>));
  }
};
<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">test</span>.<span class="cm-property">addPropTo</span>([<span class="cm-number">5</span>]));
<span class="cm-comment">// → [15]</span></pre>
<p><a class=p_ident id="p_xvW9OVp2pQ" href="#p_xvW9OVp2pQ"></a>La función pasada al <em>map</em> es el resultado de la llamada de enlace (<em>bind call</em>) y por lo tanto <em>this</em> está vinculado al primer argumento dado a <em>bind</em>, el valor <em>this</em> de la función externa (que contiene el objeto de prueba).</p>
<p><a class=p_ident id="p_91l6/hRLN8" href="#p_91l6/hRLN8"></a>La mayoría de los métodos estándar de orden superior en matrices (<em>arrays</em>), como <em>forEach</em> y <em>map</em>, toman un segundo argumento opcional que también se puede utilizar para proporcionar un <em>this</em> para las llamadas a la función de iteración. Así que podría expresar el ejemplo anterior de una manera un poco más simple.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_L0yHsXztiJ" href="#c_L0yHsXztiJ"></a><span class="cm-keyword">var</span> <span class="cm-variable">test</span> <span class="cm-operator">=</span> {
  <span class="cm-property">prop</span>: <span class="cm-number">10</span>,
  <span class="cm-property">addPropTo</span>: <span class="cm-keyword">function</span>(<span class="cm-def">array</span>) {
    <span class="cm-keyword">return</span> <span class="cm-variable-2">array</span>.<span class="cm-property">map</span>(<span class="cm-keyword">function</span>(<span class="cm-def">elt</span>) {
      <span class="cm-keyword">return</span> <span class="cm-keyword">this</span>.<span class="cm-property">prop</span> <span class="cm-operator">+</span> <span class="cm-variable-2">elt</span>;
    }, <span class="cm-keyword">this</span>); <span class="cm-comment">// ← no bind</span>
  }
};
<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">test</span>.<span class="cm-property">addPropTo</span>([<span class="cm-number">5</span>]));
<span class="cm-comment">// → [15]</span></pre>
<p><a class=p_ident id="p_/3QjoMzqxg" href="#p_/3QjoMzqxg"></a>Esto sólo funciona para las funciones de orden superior que soportan dicho parámetro de contexto. Cuando no lo hacen, tendrá que utilizar uno de los otros enfoques.</p>
<p><a class=p_ident id="p_m/AWd1YMwn" href="#p_m/AWd1YMwn"></a>En nuestras propias funciones de orden superior, podemos utilizar este parámetro de contexto utilizando el método <em>call</em> para llamar a la función dada como argumento. Por ejemplo, aquí hay un método <em>forEach</em> para nuestro tipo <em>Grid</em>, que llama a una función dada para cada elemento de la cuadrícula que no es <em>null</em> o <em>undefined</em>:</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_tJQCEockLE" href="#c_tJQCEockLE"></a><span class="cm-variable">Grid</span>.<span class="cm-property">prototype</span>.<span class="cm-property">forEach</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">f</span>, <span class="cm-def">context</span>) {
  <span class="cm-keyword">for</span> (<span class="cm-keyword">var</span> <span class="cm-def">y</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">y</span> <span class="cm-operator">&lt;</span> <span class="cm-keyword">this</span>.<span class="cm-property">height</span>; <span class="cm-variable-2">y</span><span class="cm-operator">++</span>) {
    <span class="cm-keyword">for</span> (<span class="cm-keyword">var</span> <span class="cm-def">x</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">x</span> <span class="cm-operator">&lt;</span> <span class="cm-keyword">this</span>.<span class="cm-property">width</span>; <span class="cm-variable-2">x</span><span class="cm-operator">++</span>) {
      <span class="cm-keyword">var</span> <span class="cm-def">value</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">space</span>[<span class="cm-variable-2">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">y</span> <span class="cm-operator">*</span> <span class="cm-keyword">this</span>.<span class="cm-property">width</span>];
      <span class="cm-keyword">if</span> (<span class="cm-variable-2">value</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>)
        <span class="cm-variable-2">f</span>.<span class="cm-property">call</span>(<span class="cm-variable-2">context</span>, <span class="cm-variable-2">value</span>, <span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>(<span class="cm-variable-2">x</span>, <span class="cm-variable-2">y</span>));
    }
  }
};</pre>
<h2><a class=h_ident id="h_MBXG1fiLaM" href="#h_MBXG1fiLaM"></a>Animando la vida</h2>
<p><a class=p_ident id="p_fs0YU5Q7Fz" href="#p_fs0YU5Q7Fz"></a>El siguiente paso es escribir un método de <em>turn</em> para el objeto <em>word</em> que da a los bichos la oportunidad de actuar. Recorrerá la cuadrícula usando el método <em>forEach</em> que acabamos de definir, buscando objetos con un método <em>act</em>. Cuando encuentre uno, <em>turn</em> llamadra dicho método <em>act</em> para obtener un objeto y llevar a cabo ese tipo de acción. Por ahora, solo se entienden las acciones tipo "mover".</p>
<p><a class=p_ident id="p_ijiGeknzrL" href="#p_ijiGeknzrL"></a>Hay un problema potencial con este enfoque. ¿Puedes detectarlo? Si dejamos que los bichos se muevan al cruzarlos, pueden moverse a un cuadrado que todavía no hemos visto, y les permitiremos moverse de nuevo cuando alcancemos ese cuadrado. Por lo tanto, tenemos que mantener una serie de criaturas que ya han tenido su turno e ignorarlos cuando los vemos de nuevo.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_Uiw3etHkwj" href="#c_Uiw3etHkwj"></a><span class="cm-variable">World</span>.<span class="cm-property">prototype</span>.<span class="cm-property">turn</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>() {
  <span class="cm-keyword">var</span> <span class="cm-def">acted</span> <span class="cm-operator">=</span> [];
  <span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">forEach</span>(<span class="cm-keyword">function</span>(<span class="cm-def">critter</span>, <span class="cm-def">vector</span>) {
    <span class="cm-keyword">if</span> (<span class="cm-variable-2">critter</span>.<span class="cm-property">act</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable-2">acted</span>.<span class="cm-property">indexOf</span>(<span class="cm-variable-2">critter</span>) <span class="cm-operator">==</span> <span class="cm-operator">-</span><span class="cm-number">1</span>) {
      <span class="cm-variable-2">acted</span>.<span class="cm-property">push</span>(<span class="cm-variable-2">critter</span>);
      <span class="cm-keyword">this</span>.<span class="cm-property">letAct</span>(<span class="cm-variable-2">critter</span>, <span class="cm-variable-2">vector</span>);
    }
  }, <span class="cm-keyword">this</span>);
};</pre>
<p><a class=p_ident id="p_tJ3LBvj8PD" href="#p_tJ3LBvj8PD"></a>Utilizamos el segundo parámetro del método <em>forEach</em> de la cuadrícula para poder acceder al <em>this</em> correcto dentro de la función interna. El método <em>letAct</em> contiene la lógica real que permite a los <em>critters</em> moverse.</p>
<pre id="checkDestination" data-language="javascript" class="snippet cm-s-default"><span class="cm-variable">World</span>.<span class="cm-property">prototype</span>.<span class="cm-property">letAct</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">critter</span>, <span class="cm-def">vector</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">action</span> <span class="cm-operator">=</span> <span class="cm-variable-2">critter</span>.<span class="cm-property">act</span>(<span class="cm-keyword">new</span> <span class="cm-variable">View</span>(<span class="cm-keyword">this</span>, <span class="cm-variable-2">vector</span>));
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">action</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable-2">action</span>.<span class="cm-property">type</span> <span class="cm-operator">==</span> <span class="cm-string">"move"</span>) {
    <span class="cm-keyword">var</span> <span class="cm-def">dest</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">checkDestination</span>(<span class="cm-variable-2">action</span>, <span class="cm-variable-2">vector</span>);
    <span class="cm-keyword">if</span> (<span class="cm-variable-2">dest</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">get</span>(<span class="cm-variable-2">dest</span>) <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {
      <span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">set</span>(<span class="cm-variable-2">vector</span>, <span class="cm-atom">null</span>);
      <span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">set</span>(<span class="cm-variable-2">dest</span>, <span class="cm-variable-2">critter</span>);
    }
  }
};

<span class="cm-variable">World</span>.<span class="cm-property">prototype</span>.<span class="cm-property">checkDestination</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">action</span>, <span class="cm-def">vector</span>) {
  <span class="cm-keyword">if</span> (<span class="cm-variable">directions</span>.<span class="cm-property">hasOwnProperty</span>(<span class="cm-variable-2">action</span>.<span class="cm-property">direction</span>)) {
    <span class="cm-keyword">var</span> <span class="cm-def">dest</span> <span class="cm-operator">=</span> <span class="cm-variable-2">vector</span>.<span class="cm-property">plus</span>(<span class="cm-variable">directions</span>[<span class="cm-variable-2">action</span>.<span class="cm-property">direction</span>]);
    <span class="cm-keyword">if</span> (<span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">isInside</span>(<span class="cm-variable-2">dest</span>))
      <span class="cm-keyword">return</span> <span class="cm-variable-2">dest</span>;
  }
};</pre>
<p><a class=p_ident id="p_SErda1uPX8" href="#p_SErda1uPX8"></a>Primero, pedimos simplemente al <em>critter</em> que actúe, pasándola un objeto <em>view</em> con datos sobre el mundo y la posición actual de la criatura (definiremos <em>view</em> en un <a href="07_elife.html#view">momento</a>). El método <em>act</em> devuelve una acción de algún tipo.</p>
<p><a class=p_ident id="p_H4HwPQhu8y" href="#p_H4HwPQhu8y"></a>Si el tipo (<em>type</em>) de la acción no es "mover", se ignora. Si es "mover", si tiene una propiedad de dirección que se refiere a una dirección válida, y si el cuadrado en esa dirección es vacío (<em>null</em>), fijamos el cuadrado donde el <em>critter</em> estaba como <em>null</em> y almacenamos el critter en el cuadrado de destino.</p>
<p><a class=p_ident id="p_4gS4PKZgGP" href="#p_4gS4PKZgGP"></a>Tenga en cuenta que <em>letAct</em> se encarga de ignorar la entrada no valida, no asume que la propiedad <em>direction</em> de la acción es válida o que la propiedad <em>type</em> tiene sentido. Este tipo de (programación defensiva) tiene sentido en algunas situaciones. La principal razón para hacerlo es validar entradas procedentes de fuentes que no controla (como la entrada de usuario o de archivo), pero también puede ser útil para aislar subsistemas entre sí. En este caso, la intención es que los <em>critters</em> puedan ser programados descuidadamente (no tienen que verificar si sus acciones previstas tienen sentido. Pueden solicitar una acción, y el mundo averiguará si permitirla).</p>
<p><a class=p_ident id="p_5a9MkqpdLl" href="#p_5a9MkqpdLl"></a>Estos dos métodos no forman parte de la interfaz externa de un objeto <em>World</em>. Ellos son un detalle interno. Algunos lenguajes proporcionan formas de declarar explícitamente ciertos métodos y propiedades privadas y señalan un error cuando intenta utilizarlos desde fuera del objeto. JavaScript no, por lo que tendrá que depender de alguna otra forma de comunicación para describir lo que es parte de la interfaz de un objeto. A veces puede ayudar utilizar un esquema de nomenclatura para distinguir entre propiedades externas e internas, por ejemplo prefijando todas las internas con un carácter de subrayado (_). Esto hará que los usos accidentales de las propiedades que no sean parte de la interfaz de un objeto sean más fáciles de detectar.</p>
<p id="view"><a class=p_ident id="p_lJiKcVluBs" href="#p_lJiKcVluBs"></a>La parte que falta, el tipo <em>view</em>, se parece a esto:</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_1AHaBWMXKm" href="#c_1AHaBWMXKm"></a><span class="cm-keyword">function</span> <span class="cm-variable">View</span>(<span class="cm-def">world</span>, <span class="cm-def">vector</span>) {
  <span class="cm-keyword">this</span>.<span class="cm-property">world</span> <span class="cm-operator">=</span> <span class="cm-variable-2">world</span>;
  <span class="cm-keyword">this</span>.<span class="cm-property">vector</span> <span class="cm-operator">=</span> <span class="cm-variable-2">vector</span>;
}
<span class="cm-variable">View</span>.<span class="cm-property">prototype</span>.<span class="cm-property">look</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">dir</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">target</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">vector</span>.<span class="cm-property">plus</span>(<span class="cm-variable">directions</span>[<span class="cm-variable-2">dir</span>]);
  <span class="cm-keyword">if</span> (<span class="cm-keyword">this</span>.<span class="cm-property">world</span>.<span class="cm-property">grid</span>.<span class="cm-property">isInside</span>(<span class="cm-variable-2">target</span>))
    <span class="cm-keyword">return</span> <span class="cm-variable">charFromElement</span>(<span class="cm-keyword">this</span>.<span class="cm-property">world</span>.<span class="cm-property">grid</span>.<span class="cm-property">get</span>(<span class="cm-variable-2">target</span>));
  <span class="cm-keyword">else</span>
    <span class="cm-keyword">return</span> <span class="cm-string">"#"</span>;
};
<span class="cm-variable">View</span>.<span class="cm-property">prototype</span>.<span class="cm-property">findAll</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">ch</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">found</span> <span class="cm-operator">=</span> [];
  <span class="cm-keyword">for</span> (<span class="cm-keyword">var</span> <span class="cm-def">dir</span> <span class="cm-keyword">in</span> <span class="cm-variable">directions</span>)
    <span class="cm-keyword">if</span> (<span class="cm-keyword">this</span>.<span class="cm-property">look</span>(<span class="cm-variable-2">dir</span>) <span class="cm-operator">==</span> <span class="cm-variable-2">ch</span>)
      <span class="cm-variable-2">found</span>.<span class="cm-property">push</span>(<span class="cm-variable-2">dir</span>);
  <span class="cm-keyword">return</span> <span class="cm-variable-2">found</span>;
};
<span class="cm-variable">View</span>.<span class="cm-property">prototype</span>.<span class="cm-property">find</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">ch</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">found</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">findAll</span>(<span class="cm-variable-2">ch</span>);
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">found</span>.<span class="cm-property">length</span> <span class="cm-operator">==</span> <span class="cm-number">0</span>) <span class="cm-keyword">return</span> <span class="cm-atom">null</span>;
  <span class="cm-keyword">return</span> <span class="cm-variable">randomElement</span>(<span class="cm-variable-2">found</span>);
};</pre>
<p><a class=p_ident id="p_0A2FCm8lrj" href="#p_0A2FCm8lrj"></a>El método <em>look</em> calcula las coordenadas que estamos tratando de ver y, si están dentro de la cuadrícula, encuentra el carácter correspondiente al elemento que se encuentra allí. Para las coordenadas fuera de la cuadrícula, <em>look</em> simplemente finge que hay una pared allí de modo que si usted define un mundo sin paredes, las criaturasno serán tentadas de intentar caminar fuera de los bordes.</p>
<h2><a class=h_ident id="h_1LLDINfQuv" href="#h_1LLDINfQuv"></a>Se mueve</h2>
<p><a class=p_ident id="p_QWUxPullzP" href="#p_QWUxPullzP"></a>Hemos instanciado un objeto del mundo anterior. Ahora que hemos añadido todos los métodos necesarios, debería ser posible hacer que el mundo se mueva.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_tvpH6fEaia" href="#c_tvpH6fEaia"></a><span class="cm-keyword">for</span> (<span class="cm-keyword">var</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">5</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {
  <span class="cm-variable">world</span>.<span class="cm-property">turn</span>();
  <span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">world</span>.<span class="cm-property">toString</span>());
}
<span class="cm-comment">// → … five turns of moving critters</span></pre>
<div class="literalblock">
<div class="content monospaced">
<pre>ifdef::book_target[]</pre>
</div></div>
<p><a class=p_ident id="p_9j8Ya7SaDm" href="#p_9j8Ya7SaDm"></a>Los primeros dos mapas que se muestran será algo similar a esto:</p>
<pre>############################  ############################
#      #    #             ##  #      #    #             ##
#                   o      #  #                          #
#          #####           #  #          #####     o     #
##         #   #    ##     #  ##         #   #    ##     #
###           ##     #     #  ###           ##     #     #
#           ###      #     #  #           ###      #     #
#   ####                   #  #   ####                   #
#   ##                     #  #   ##                     #
#    #       o         ### #  #o   #                 ### #
#o   #          o          #  #    #       o o           #
############################  ############################</pre>
<p><a class=p_ident id="p_E3Ge6DhV+K" href="#p_E3Ge6DhV+K"></a> ¡Ellos mueven! Para obtener una visión más interactiva de estas
criaturas que se arrastran y rebotan en las paredes, abra este capítulo en la versión on-line del libro <a href="http://eloquentjavascript.net"><em>eloquentjavascript.net</em></a>.</p>
<p><a class=p_ident id="p_TNzyra+CrL" href="#p_TNzyra+CrL"></a>Sin embargo, imprimir muchas copias del mapa es una manera bastante desagradable de observar un mundo. Es por eso que el <em>sandbox</em> proporciona una función <em>animateWorld</em> que ejecutará un mundo como una animación en pantalla, moviéndose tres veces por segundo, hasta que pulse el botón de parada.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_GWmwbCld+R" href="#c_GWmwbCld+R"></a><span class="cm-variable">animateWorld</span>(<span class="cm-variable">world</span>);
<span class="cm-comment">// → … life!</span></pre>
<p><a class=p_ident id="p_Cd6a7yjcnP" href="#p_Cd6a7yjcnP"></a>La implementación de <em>animateWorld</em> seguirá siendo un misterio por ahora, pero después de haber leído los <a href="13_dom.html#dom">capítulos posteriores</a> de este libro, y estudiar la integración de JavaScript en los navegadores web, ya no se verá tan mágico.</p>
<h2><a class=h_ident id="h_LIUO26pcSa" href="#h_LIUO26pcSa"></a>Más formas de vida</h2>
<p><a class=p_ident id="p_VxyI+rbNlk" href="#p_VxyI+rbNlk"></a>El punto culminante dramático de nuestro mundo, si usted mira para un pedacito, es cuando dos <em>critters</em> rebotan el uno al otro. ¿Puedes pensar en otra forma interesante de comportamiento?</p>
<p><a class=p_ident id="p_ueRxBeKbv5" href="#p_ueRxBeKbv5"></a>Podemos hacer un <em>critter</em> que se mueve a lo largo de las paredes (<em>WallFollower</em>).  Conceptualmente, el critter mantiene su mano izquierda (pata, tentáculo, lo que sea) a la pared y sigue adelante. Este no es un cambio trivial de implementar:</p>
<p><a class=p_ident id="p_vKQ1Jlu5tf" href="#p_vKQ1Jlu5tf"></a> Tenemos que ser capaces de “hacer calculos" con las direcciones de la brújula. Como las direcciones son modeladas por un conjunto de cadenas, deberíamos definir nuestra propia operación (<em>dirPlus</em>) para calcular direcciones relativas. Así dirPlus ("<em>n</em>", <em>1</em>) significa una vuelta de 45 grados en sentido horario desde el norte, dando "<em>ne</em>". Del mismo modo, dirPlus ("<em>s</em>", <em>-2</em>) significa 90 grados en sentido antihorario desde el sur, que es el este.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_/f16aAnRw9" href="#c_/f16aAnRw9"></a><span class="cm-keyword">function</span> <span class="cm-variable">dirPlus</span>(<span class="cm-def">dir</span>, <span class="cm-def">n</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">index</span> <span class="cm-operator">=</span> <span class="cm-variable">directionNames</span>.<span class="cm-property">indexOf</span>(<span class="cm-variable-2">dir</span>);
  <span class="cm-keyword">return</span> <span class="cm-variable">directionNames</span>[(<span class="cm-variable-2">index</span> <span class="cm-operator">+</span> <span class="cm-variable-2">n</span> <span class="cm-operator">+</span> <span class="cm-number">8</span>) <span class="cm-operator">%</span> <span class="cm-number">8</span>];
}

<span class="cm-keyword">function</span> <span class="cm-variable">WallFollower</span>() {
  <span class="cm-keyword">this</span>.<span class="cm-property">dir</span> <span class="cm-operator">=</span> <span class="cm-string">"s"</span>;
}

<span class="cm-variable">WallFollower</span>.<span class="cm-property">prototype</span>.<span class="cm-property">act</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">view</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">start</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">dir</span>;
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">view</span>.<span class="cm-property">look</span>(<span class="cm-variable">dirPlus</span>(<span class="cm-keyword">this</span>.<span class="cm-property">dir</span>, <span class="cm-operator">-</span><span class="cm-number">3</span>)) <span class="cm-operator">!=</span> <span class="cm-string">" "</span>)
    <span class="cm-variable-2">start</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">dir</span> <span class="cm-operator">=</span> <span class="cm-variable">dirPlus</span>(<span class="cm-keyword">this</span>.<span class="cm-property">dir</span>, <span class="cm-operator">-</span><span class="cm-number">2</span>);
  <span class="cm-keyword">while</span> (<span class="cm-variable-2">view</span>.<span class="cm-property">look</span>(<span class="cm-keyword">this</span>.<span class="cm-property">dir</span>) <span class="cm-operator">!=</span> <span class="cm-string">" "</span>) {
    <span class="cm-keyword">this</span>.<span class="cm-property">dir</span> <span class="cm-operator">=</span> <span class="cm-variable">dirPlus</span>(<span class="cm-keyword">this</span>.<span class="cm-property">dir</span>, <span class="cm-number">1</span>);
    <span class="cm-keyword">if</span> (<span class="cm-keyword">this</span>.<span class="cm-property">dir</span> <span class="cm-operator">==</span> <span class="cm-variable-2">start</span>) <span class="cm-keyword">break</span>;
  }
  <span class="cm-keyword">return</span> {<span class="cm-property">type</span>: <span class="cm-string">"move"</span>, <span class="cm-property">direction</span>: <span class="cm-keyword">this</span>.<span class="cm-property">dir</span>};
};</pre>
<p><a class=p_ident id="p_5XpQMAFLcP" href="#p_5XpQMAFLcP"></a>El método <em>act</em> sólo tiene que "escanear" el entorno del <em>critter</em>, comenzando por su lado izquierdo y en sentido horario hasta encontrar un cuadrado vacío. Entonces se mueve en la dirección de ese cuadrado vacío.</p>
<p><a class=p_ident id="p_pyq93d0K4z" href="#p_pyq93d0K4z"></a>Lo que complica las cosas es que un <em>critter</em> puede terminar en el medio del espacio vacío, ya sea como su posición inicial o como resultado de caminar alrededor de otro <em>critter</em>. Si aplicamos el enfoque que acabo de describir en el espacio vacío, el pobre <em>critter</em> seguirá girando a la izquierda en cada paso, corriendo en círculos.</p>
<p><a class=p_ident id="p_QWLV4ThHKd" href="#p_QWLV4ThHKd"></a>De modo que hay una comprobación extra (la sentencia <em>if</em>) para iniciar el escaneado hacia la izquierda sólo si parece que el <em>critter</em> acaba de pasar algún tipo de obstáculo, es decir, si el espacio detrás y hacia la izquierda del <em>critter</em> no está vacío. De lo contrario, el <em>critter</em> comienza a escanear directamente delante, de modo que va a caminar recto en el espacio vacío.</p>
<p><a class=p_ident id="p_4h6273I6TW" href="#p_4h6273I6TW"></a>Y finalmente, hay una prueba que compara <em>this.dir</em> con <em>start</em> después de cada paso a través del <em>loop</em> para cerciorarse de que el <em>loop</em> no funcionará para siempre cuando el <em>critter</em> está amurallado adentro o apretado adentro por otros <em>critters</em> y no puede encontrar un cuadrado vacío.</p>
<p><a class=p_ident id="p_SJkhaPPm+i" href="#p_SJkhaPPm+i"></a>Este pequeño mundo muestra las criaturas que siguen la pared:</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_bE8wiFAYHa" href="#c_bE8wiFAYHa"></a><span class="cm-variable">animateWorld</span>(<span class="cm-keyword">new</span> <span class="cm-variable">World</span>(
  [<span class="cm-string">"############"</span>,
   <span class="cm-string">"#     #    #"</span>,
   <span class="cm-string">"#   ~    ~ #"</span>,
   <span class="cm-string">"#  ##      #"</span>,
   <span class="cm-string">"#  ##  o####"</span>,
   <span class="cm-string">"#          #"</span>,
   <span class="cm-string">"############"</span>],
  {<span class="cm-string cm-property">"#"</span>: <span class="cm-variable">Wall</span>,
   <span class="cm-string cm-property">"~"</span>: <span class="cm-variable">WallFollower</span>,
   <span class="cm-string cm-property">"o"</span>: <span class="cm-variable">BouncingCritter</span>}
));</pre>
<h2><a class=h_ident id="h_hGJInZK/Fe" href="#h_hGJInZK/Fe"></a>Una simulación más realista</h2>
<p><a class=p_ident id="p_VzCv6oiULm" href="#p_VzCv6oiULm"></a>Para hacer la vida en nuestro mundo más interesante, vamos a añadir los conceptos de la comida y la reproducción. Cada ser vivo en el mundo recibe una nueva propiedad, la energía, que se reduce mediante la realización de acciones y el aumento de comer cosas. Cuando la criatura tiene suficiente energía, puede reproducirse, generando una nueva criatura del mismo tipo. Para mantener las cosas simples, las criaturas en nuestro mundo se reproducen asexualmente por sí solas.</p>
<p><a class=p_ident id="p_1QSKL1OAvm" href="#p_1QSKL1OAvm"></a>Si los bichos sólo se mueven y comen unos a otros, el mundo pronto sucumbirá a la ley de entropía creciente, se quedará sin energía, y se convertirá en un desierto sin vida. Para evitar que esto suceda (demasiado rápido, al menos), añadimos plantas al mundo. Las plantas no se mueven. Simplemente utilizan la fotosíntesis para crecer (es decir, aumentar su energía) y reproducirse.</p>
<p><a class=p_ident id="p_Hf3ozTi/bG" href="#p_Hf3ozTi/bG"></a>Para que esto funcione, necesitaremos un mundo con un método <em>letAct</em> diferente. Podríamos simplemente reemplazar el método del (prototipo <em>world</em>), pero me he vuelto muy apegado a nuestra simulación con las criaturas que siguen a la pared y odiaría romper ese viejo mundo.</p>
<p><a class=p_ident id="p_mEflbI/g7U" href="#p_mEflbI/g7U"></a>Una solución es usar la (herencia). Creamos un nuevo (constructor), <em>LifelikeWorld</em>, cuyo prototipo se basa en el (prototipo World) pero que anula el método <em>letAct</em>. El nuevo método <em>letAct</em> delega el trabajo de realizar una acción a varias funciones almacenadas en el objeto <em>actionTypes</em>.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_Xq/SMOEf8t" href="#c_Xq/SMOEf8t"></a><span class="cm-keyword">function</span> <span class="cm-variable">LifelikeWorld</span>(<span class="cm-def">map</span>, <span class="cm-def">legend</span>) {
  <span class="cm-variable">World</span>.<span class="cm-property">call</span>(<span class="cm-keyword">this</span>, <span class="cm-variable-2">map</span>, <span class="cm-variable-2">legend</span>);
}
<span class="cm-variable">LifelikeWorld</span>.<span class="cm-property">prototype</span> <span class="cm-operator">=</span> <span class="cm-variable">Object</span>.<span class="cm-property">create</span>(<span class="cm-variable">World</span>.<span class="cm-property">prototype</span>);

<span class="cm-keyword">var</span> <span class="cm-variable">actionTypes</span> <span class="cm-operator">=</span> <span class="cm-variable">Object</span>.<span class="cm-property">create</span>(<span class="cm-atom">null</span>);

<span class="cm-variable">LifelikeWorld</span>.<span class="cm-property">prototype</span>.<span class="cm-property">letAct</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">critter</span>, <span class="cm-def">vector</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">action</span> <span class="cm-operator">=</span> <span class="cm-variable-2">critter</span>.<span class="cm-property">act</span>(<span class="cm-keyword">new</span> <span class="cm-variable">View</span>(<span class="cm-keyword">this</span>, <span class="cm-variable-2">vector</span>));
  <span class="cm-keyword">var</span> <span class="cm-def">handled</span> <span class="cm-operator">=</span> <span class="cm-variable-2">action</span> <span class="cm-operator">&amp;&amp;</span>
    <span class="cm-variable-2">action</span>.<span class="cm-property">type</span> <span class="cm-keyword">in</span> <span class="cm-variable">actionTypes</span> <span class="cm-operator">&amp;&amp;</span>
    <span class="cm-variable">actionTypes</span>[<span class="cm-variable-2">action</span>.<span class="cm-property">type</span>].<span class="cm-property">call</span>(<span class="cm-keyword">this</span>, <span class="cm-variable-2">critter</span>,
                                  <span class="cm-variable-2">vector</span>, <span class="cm-variable-2">action</span>);
  <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable-2">handled</span>) {
    <span class="cm-variable-2">critter</span>.<span class="cm-property">energy</span> <span class="cm-operator">-=</span> <span class="cm-number">0.2</span>;
    <span class="cm-keyword">if</span> (<span class="cm-variable-2">critter</span>.<span class="cm-property">energy</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">0</span>)
      <span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">set</span>(<span class="cm-variable-2">vector</span>, <span class="cm-atom">null</span>);
  }
};</pre>
<p><a class=p_ident id="p_1YGA51EDNJ" href="#p_1YGA51EDNJ"></a>El nuevo método <em>letAct</em> comprueba primero si se ha devuelto una acción, si existe una (función de controlador) para este tipo de acción y, por último, si ese controlador devuelve <em>true</em>, lo que indica que se ha tratado correctamente la acción.</p>
<p><a class=p_ident id="p_x80C/HfKgK" href="#p_x80C/HfKgK"></a>Tenga en cuenta el uso de <em>call</em> para dar al manejador acceso al mundo a través de <em>this</em>.
Si la acción no funcionó por alguna razón, la acción predeterminada es que la criatura simplemente espere. Pierde un quinto punto de energía, y si su nivel de energía es igual o menor que cero, la criatura muere y se borra de la cuadrícula.</p>
<h2><a class=h_ident id="h_e5+Tgf3i6/" href="#h_e5+Tgf3i6/"></a>Manejadores de acciones</h2>
<p><a class=p_ident id="p_2jmj7l5rSw" href="#p_2jmj7l5rSw"></a></p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_wHH+c78jV5" href="#c_wHH+c78jV5"></a><span class="cm-variable">actionTypes</span>.<span class="cm-property">grow</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">critter</span>) {
  <span class="cm-variable-2">critter</span>.<span class="cm-property">energy</span> <span class="cm-operator">+=</span> <span class="cm-number">0.5</span>;
  <span class="cm-keyword">return</span> <span class="cm-atom">true</span>;
};</pre>
<p><a class=p_ident id="p_1Xlwfe6icP" href="#p_1Xlwfe6icP"></a>Crecer siempre tiene éxito y añade medio punto al nivel de energía (<em>energy</em>) de la planta.
Moverse es más complicado.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_EgcpmD74TO" href="#c_EgcpmD74TO"></a><span class="cm-variable">actionTypes</span>.<span class="cm-property">move</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">critter</span>, <span class="cm-def">vector</span>, <span class="cm-def">action</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">dest</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">checkDestination</span>(<span class="cm-variable-2">action</span>, <span class="cm-variable-2">vector</span>);
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">dest</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span> <span class="cm-operator">||</span>
      <span class="cm-variable-2">critter</span>.<span class="cm-property">energy</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">1</span> <span class="cm-operator">||</span>
      <span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">get</span>(<span class="cm-variable-2">dest</span>) <span class="cm-operator">!=</span> <span class="cm-atom">null</span>)
    <span class="cm-keyword">return</span> <span class="cm-atom">false</span>;
  <span class="cm-variable-2">critter</span>.<span class="cm-property">energy</span> <span class="cm-operator">-=</span> <span class="cm-number">1</span>;
  <span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">set</span>(<span class="cm-variable-2">vector</span>, <span class="cm-atom">null</span>);
  <span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">set</span>(<span class="cm-variable-2">dest</span>, <span class="cm-variable-2">critter</span>);
  <span class="cm-keyword">return</span> <span class="cm-atom">true</span>;
};</pre>
<p><a class=p_ident id="p_4rU9og3M2Z" href="#p_4rU9og3M2Z"></a>Esta acción comprueba primero, utilizando el método <em>checkDestination</em> definido anteriormente, si la acción proporciona un destino válido. Si no, o si el destino no está vacío, o si el <em>critter</em> carece de la energía requerida, <em>move</em> devuelve false para indicar que no se tomó ninguna acción. De lo contrario, se mueve el <em>critter</em> y resta el costo de la energía.</p>
<p><a class=p_ident id="p_+Bbdnx9/+j" href="#p_+Bbdnx9/+j"></a>Además de moverse, las criaturas pueden comer.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_cQhl6uK2Jo" href="#c_cQhl6uK2Jo"></a><span class="cm-variable">actionTypes</span>.<span class="cm-property">eat</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">critter</span>, <span class="cm-def">vector</span>, <span class="cm-def">action</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">dest</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">checkDestination</span>(<span class="cm-variable-2">action</span>, <span class="cm-variable-2">vector</span>);
  <span class="cm-keyword">var</span> <span class="cm-def">atDest</span> <span class="cm-operator">=</span> <span class="cm-variable-2">dest</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">get</span>(<span class="cm-variable-2">dest</span>);
  <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable-2">atDest</span> <span class="cm-operator">||</span> <span class="cm-variable-2">atDest</span>.<span class="cm-property">energy</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>)
    <span class="cm-keyword">return</span> <span class="cm-atom">false</span>;
  <span class="cm-variable-2">critter</span>.<span class="cm-property">energy</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">atDest</span>.<span class="cm-property">energy</span>;
  <span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">set</span>(<span class="cm-variable-2">dest</span>, <span class="cm-atom">null</span>);
  <span class="cm-keyword">return</span> <span class="cm-atom">true</span>;
};</pre>
<p><a class=p_ident id="p_ahgoSzGjZw" href="#p_ahgoSzGjZw"></a>Comer otra criatura (<em>critter</em>) también implica proporcionar un cuadrado de destino válido. Esta vez, el destino no debe estar vacío y debe contener algo con energía, como un <em>critter</em> (pero no una pared - las paredes no son comestibles). Si es así, la energía de la comida es transferida al comedor, y la víctima es removida de la cuadrícula.</p>
<p><a class=p_ident id="p_376Zmtnq+i" href="#p_376Zmtnq+i"></a>Y finalmente, permitimos que nuestras criaturas se reproduzcan.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_0hQdcXq3OA" href="#c_0hQdcXq3OA"></a><span class="cm-variable">actionTypes</span>.<span class="cm-property">reproduce</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">critter</span>, <span class="cm-def">vector</span>, <span class="cm-def">action</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">baby</span> <span class="cm-operator">=</span> <span class="cm-variable">elementFromChar</span>(<span class="cm-keyword">this</span>.<span class="cm-property">legend</span>,
                             <span class="cm-variable-2">critter</span>.<span class="cm-property">originChar</span>);
  <span class="cm-keyword">var</span> <span class="cm-def">dest</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">checkDestination</span>(<span class="cm-variable-2">action</span>, <span class="cm-variable-2">vector</span>);
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">dest</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span> <span class="cm-operator">||</span>
      <span class="cm-variable-2">critter</span>.<span class="cm-property">energy</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">2</span> <span class="cm-operator">*</span> <span class="cm-variable-2">baby</span>.<span class="cm-property">energy</span> <span class="cm-operator">||</span>
      <span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">get</span>(<span class="cm-variable-2">dest</span>) <span class="cm-operator">!=</span> <span class="cm-atom">null</span>)
    <span class="cm-keyword">return</span> <span class="cm-atom">false</span>;
  <span class="cm-variable-2">critter</span>.<span class="cm-property">energy</span> <span class="cm-operator">-=</span> <span class="cm-number">2</span> <span class="cm-operator">*</span> <span class="cm-variable-2">baby</span>.<span class="cm-property">energy</span>;
  <span class="cm-keyword">this</span>.<span class="cm-property">grid</span>.<span class="cm-property">set</span>(<span class="cm-variable-2">dest</span>, <span class="cm-variable-2">baby</span>);
  <span class="cm-keyword">return</span> <span class="cm-atom">true</span>;
};</pre>
<p><a class=p_ident id="p_v9g2QPegnu" href="#p_v9g2QPegnu"></a>Reproducirse cuesta dos veces el nivel de energía de un <em>critter</em> recién nacido. Así que primero creamos un bebé (hipotético) usando <em>elementFromChar</em> en el propio carácter de origen del <em>critter</em>. Una vez que tenemos un bebé, podemos encontrar su nivel de energía y probar si el padre tiene suficiente energía para llevarlo con éxito al mundo. También necesitamos un destino válido (y vacío).</p>
<p><a class=p_ident id="p_vovoQdfwDb" href="#p_vovoQdfwDb"></a>Si todo está bien, el bebé es puesto en la cuadrícula (ya no es hipotético), y la energía se gasta.</p>
<h2><a class=h_ident id="h_vSsa2oSOhH" href="#h_vSsa2oSOhH"></a>Llenar el nuevo mundo</h2>
<p><a class=p_ident id="p_tf0dWD9mWv" href="#p_tf0dWD9mWv"></a>Ahora tenemos un marco (<em>framework</em>) para simular estas criaturas en forma más realista. Podríamos poner las criaturas del viejo mundo en ella, pero sólo morirían ya que no tienen una propiedad de energía. Así que hagamos nuevos. Primero escribiremos una planta (<em>Plant</em>), que es una forma de vida bastante simple.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_RQsOcWcml/" href="#c_RQsOcWcml/"></a><span class="cm-keyword">function</span> <span class="cm-variable">Plant</span>() {
  <span class="cm-keyword">this</span>.<span class="cm-property">energy</span> <span class="cm-operator">=</span> <span class="cm-number">3</span> <span class="cm-operator">+</span> <span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">*</span> <span class="cm-number">4</span>;
}
<span class="cm-variable">Plant</span>.<span class="cm-property">prototype</span>.<span class="cm-property">act</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">view</span>) {
  <span class="cm-keyword">if</span> (<span class="cm-keyword">this</span>.<span class="cm-property">energy</span> <span class="cm-operator">></span> <span class="cm-number">15</span>) {
    <span class="cm-keyword">var</span> <span class="cm-def">space</span> <span class="cm-operator">=</span> <span class="cm-variable-2">view</span>.<span class="cm-property">find</span>(<span class="cm-string">" "</span>);
    <span class="cm-keyword">if</span> (<span class="cm-variable-2">space</span>)
      <span class="cm-keyword">return</span> {<span class="cm-property">type</span>: <span class="cm-string">"reproduce"</span>, <span class="cm-property">direction</span>: <span class="cm-variable-2">space</span>};
  }
  <span class="cm-keyword">if</span> (<span class="cm-keyword">this</span>.<span class="cm-property">energy</span> <span class="cm-operator">&lt;</span> <span class="cm-number">20</span>)
    <span class="cm-keyword">return</span> {<span class="cm-property">type</span>: <span class="cm-string">"grow"</span>};
};</pre>
<p><a class=p_ident id="p_zPs/IRyuZQ" href="#p_zPs/IRyuZQ"></a>Las plantas comienzan con un nivel de energía entre 3 y 7, aleatorizado para que no se reproduzcan todos en el mismo turno (<em>turn</em>). Cuando una planta alcanza 15 puntos de energía y hay un espacio vacío cerca, se reproduce en ese espacio vacío. Si una planta no puede reproducirse, simplemente crece hasta alcanzar el nivel de energía 20.</p>
<p><a class=p_ident id="p_c1V22pZg9i" href="#p_c1V22pZg9i"></a>Ahora definimos un comedor de plantas (<em>PlantEater</em>).</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_ddgWDpbvSl" href="#c_ddgWDpbvSl"></a><span class="cm-keyword">function</span> <span class="cm-variable">PlantEater</span>() {
  <span class="cm-keyword">this</span>.<span class="cm-property">energy</span> <span class="cm-operator">=</span> <span class="cm-number">20</span>;
}
<span class="cm-variable">PlantEater</span>.<span class="cm-property">prototype</span>.<span class="cm-property">act</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">view</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">space</span> <span class="cm-operator">=</span> <span class="cm-variable-2">view</span>.<span class="cm-property">find</span>(<span class="cm-string">" "</span>);
  <span class="cm-keyword">if</span> (<span class="cm-keyword">this</span>.<span class="cm-property">energy</span> <span class="cm-operator">></span> <span class="cm-number">60</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable-2">space</span>)
    <span class="cm-keyword">return</span> {<span class="cm-property">type</span>: <span class="cm-string">"reproduce"</span>, <span class="cm-property">direction</span>: <span class="cm-variable-2">space</span>};
  <span class="cm-keyword">var</span> <span class="cm-def">plant</span> <span class="cm-operator">=</span> <span class="cm-variable-2">view</span>.<span class="cm-property">find</span>(<span class="cm-string">"*"</span>);
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">plant</span>)
    <span class="cm-keyword">return</span> {<span class="cm-property">type</span>: <span class="cm-string">"eat"</span>, <span class="cm-property">direction</span>: <span class="cm-variable-2">plant</span>};
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">space</span>)
    <span class="cm-keyword">return</span> {<span class="cm-property">type</span>: <span class="cm-string">"move"</span>, <span class="cm-property">direction</span>: <span class="cm-variable-2">space</span>};
};</pre>
<p><a class=p_ident id="p_Y4G1MERxuA" href="#p_Y4G1MERxuA"></a>Usaremos el carácter <em>*</em> para las plantas (<em>Plant</em>), así que eso es lo que esta criatura buscará cuando busque comida.</p>
<h2><a class=h_ident id="h_6ZzD42SQnU" href="#h_6ZzD42SQnU"></a>Darle vida</h2>
<p><a class=p_ident id="p_7XORgUXmSV" href="#p_7XORgUXmSV"></a>Y eso nos da suficientes elementos para probar nuestro nuevo mundo. Imagínese el siguiente mapa como un valle cubierto de hierba con una manada de herbívoros en ella, algunas rocas y una exuberante vegetación en todas partes.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_uxbbeqRjLM" href="#c_uxbbeqRjLM"></a><span class="cm-keyword">var</span> <span class="cm-variable">valley</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">LifelikeWorld</span>(
  [<span class="cm-string">"############################"</span>,
   <span class="cm-string">"#####                 ######"</span>,
   <span class="cm-string">"##   ***                **##"</span>,
   <span class="cm-string">"#   *##**         **  O  *##"</span>,
   <span class="cm-string">"#    ***     O    ##**    *#"</span>,
   <span class="cm-string">"#       O         ##***    #"</span>,
   <span class="cm-string">"#                 ##**     #"</span>,
   <span class="cm-string">"#   O       #*             #"</span>,
   <span class="cm-string">"#*          #**       O    #"</span>,
   <span class="cm-string">"#***        ##**    O    **#"</span>,
   <span class="cm-string">"##****     ###***       *###"</span>,
   <span class="cm-string">"############################"</span>],
  {<span class="cm-string cm-property">"#"</span>: <span class="cm-variable">Wall</span>,
   <span class="cm-string cm-property">"O"</span>: <span class="cm-variable">PlantEater</span>,
   <span class="cm-string cm-property">"*"</span>: <span class="cm-variable">Plant</span>}
);</pre>
<p><a class=p_ident id="p_iltJo+QaPI" href="#p_iltJo+QaPI"></a>Veamos ver ocurre cuando ejecutamos este codigo.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_ryt21fIzYu" href="#c_ryt21fIzYu"></a><span class="cm-variable">animateWorld</span>(<span class="cm-variable">valley</span>);</pre>
<p><a class=p_ident id="p_6atbm4+wdq" href="#p_6atbm4+wdq"></a>La mayoría de las veces, las plantas se multiplican y se expanden con bastante rapidez, pero luego la abundancia de alimentos causa una explosión poblacional de los herbívoros, que proceden a eliminar todas o casi todas las plantas, resultando en un hambre masiva de las criaturas. A veces, el ecosistema se recupera y comienza otro ciclo. En otras ocasiones, una de las especies muere completamente. Si son los herbívoros, todo el espacio se llenará de plantas. Si son las plantas, las criaturas restantes mueren de hambre, y el valle se convierte en una tierra baldía desolada. Ah, la crueldad de la naturaleza.</p>
<h2><a class=h_ident id="h_tkm7ntLto1" href="#h_tkm7ntLto1"></a>Ejercicios</h2>
<h3><a class=h_ident id="h_H1sJZuYS+n" href="#h_H1sJZuYS+n"></a>Estupidez artificial</h3>
<p><a class=p_ident id="p_jw1DXjVumM" href="#p_jw1DXjVumM"></a>Tener extinguidos a los habitantes de nuestro mundo después de unos minutos es algo deprimente. Para hacer frente a esto, podríamos tratar de crear un comedor de plantas más inteligente (<em>smarter plant eater</em>).</p>
<p><a class=p_ident id="p_/xq+FCTjvg" href="#p_/xq+FCTjvg"></a>Hay varios problemas obvios con nuestros herbívoros. En primer lugar, son terriblemente codiciosos, tragan cada planta que ven hasta que han borrado toda la vida vegetal. En segundo lugar, su movimiento al azar (recuerde que el método <em>view.find:</em> devuelve una dirección al azar cuando coinciden varias direcciones) hace que tropiecen ineficazmente y mueren de hambre si no encuentran ninguna planta cerca. Y finalmente, se reproducen muy rápido, lo que hace que los ciclos entre la abundancia y el hambre sean bastante intensos.</p>
<p><a class=p_ident id="p_QbkmlKcMft" href="#p_QbkmlKcMft"></a>Crea un nuevo tipo de <em>critter</em> intentando abordar uno o más de estos puntos y sustituyelo por el antiguo tipo <em>PlantEater</em> en el mundo del valle. Haga algunos ajustes mas si lo ve necesario.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_7OKWiyCd1B" href="#c_7OKWiyCd1B"></a><span class="cm-comment">// Your code here</span>
<span class="cm-keyword">function</span> <span class="cm-variable">SmartPlantEater</span>() {}

<span class="cm-variable">animateWorld</span>(<span class="cm-keyword">new</span> <span class="cm-variable">LifelikeWorld</span>(
  [<span class="cm-string">"############################"</span>,
   <span class="cm-string">"#####                 ######"</span>,
   <span class="cm-string">"##   ***                **##"</span>,
   <span class="cm-string">"#   *##**         **  O  *##"</span>,
   <span class="cm-string">"#    ***     O    ##**    *#"</span>,
   <span class="cm-string">"#       O         ##***    #"</span>,
   <span class="cm-string">"#                 ##**     #"</span>,
   <span class="cm-string">"#   O       #*             #"</span>,
   <span class="cm-string">"#*          #**       O    #"</span>,
   <span class="cm-string">"#***        ##**    O    **#"</span>,
   <span class="cm-string">"##****     ###***       *###"</span>,
   <span class="cm-string">"############################"</span>],
  {<span class="cm-string cm-property">"#"</span>: <span class="cm-variable">Wall</span>,
   <span class="cm-string cm-property">"O"</span>: <span class="cm-variable">SmartPlantEater</span>,
   <span class="cm-string cm-property">"*"</span>: <span class="cm-variable">Plant</span>}
));</pre>
<div class=solution><div class=solution-text>
<p><a class=p_ident id="p_Fx0/RF+KRx" href="#p_Fx0/RF+KRx"></a>El problema de la codicia puede ser atacado de varias maneras. Las criaturas podrían dejar de comer cuando alcanzan un cierto nivel de energía. O pueden comer sólo cada N vueltas (manteniendo un contador de las vueltas desde su última comida en una propiedad en el objeto de criatura). O, para asegurarse de que las plantas nunca se extingan por completo, los animales podrían negarse a comer una planta a menos que vean por lo menos una planta cercana (usando el método findAll en la vista). Una combinación de estos, o alguna estrategia totalmente diferente, también podría funcionar</p>
<p><a class=p_ident id="p_Fx0/RF+KRx" href="#p_Fx0/RF+KRx"></a>El problema de la codicia puede ser atacado de varias maneras. Las criaturas podrían dejar de comer cuando alcanzan un cierto nivel de energía (<em>energy</em>). O pueden comer sólo cada <em>N</em> vueltas (manteniendo un contador de las vueltas desde su última comida en una propiedad en el objeto <em>critters</em>). O, para asegurarse de que las plantas nunca se extingan por completo, los animales podrían negarse a comer una planta a menos que vean por lo menos una planta cercana (usando el método <em>findAll</em> en la vista). Una combinación de estos, o alguna estrategia totalmente diferente, también podría funcionar.</p>
<p><a class=p_ident id="p_GX6M1pNkjn" href="#p_GX6M1pNkjn"></a>Hacer que los bichos se muevan más eficazmente se podría hacer copiando una de las estrategias de movimiento de las criaturas en nuestro viejo mundo sin energías. Tanto el comportamiento de rebote (<em>bouncing</em>) como el comportamiento de seguimiento de la pared (<em>wall-following</em>) mostraron un rango de movimiento mucho más amplio que el escalonamiento completamente aleatorio.</p>
<p><a class=p_ident id="p_sopfPiJhH/" href="#p_sopfPiJhH/"></a>Hacer que las criaturas se reproduzcan más lentamente es trivial. Sólo aumentar el nivel mínimo de energía en la que se reproducen. Por supuesto, hacer el ecosistema más estable también lo hace más aburrido. Si tienes un puñado de criaturas gordas e inmóviles reproducirse pero siempre comiendo en un mar de plantas, tienes un ecosistema muy estable, pero muy aburrido.</p>
</div></div>
<h3><a class=h_ident id="h_UN+e8gZzwB" href="#h_UN+e8gZzwB"></a>Depredadores</h3>
<p><a class=p_ident id="p_VrAI6i9MYz" href="#p_VrAI6i9MYz"></a>Cualquier ecosistema serio tiene una cadena alimentaria más larga que un solo eslabón. Escriba otro <em>critter</em> que sobreviva comiendose al <em>critter</em>  herbívoro. Usted notará que la estabilidad es aún más difícil de lograr ahora que hay ciclos en múltiples niveles. Trate de encontrar una estrategia para hacer que el ecosistema funcione sin problemas durante al menos un tiempo.</p>
<p><a class=p_ident id="p_+3m5QcrRJJ" href="#p_+3m5QcrRJJ"></a>Una cosa que ayudará es hacer el mundo más grande. De esta manera, los auges o bajas de la población local son menos propensos a eliminar completamente una especie, y hay espacio para la población de presas relativamente grande que se necesita para mantener una pequeña población de depredadores.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_ub1nEhU4ti" href="#c_ub1nEhU4ti"></a><span class="cm-comment">// Your code here</span>
<span class="cm-keyword">function</span> <span class="cm-variable">Tiger</span>() {}

<span class="cm-variable">animateWorld</span>(<span class="cm-keyword">new</span> <span class="cm-variable">LifelikeWorld</span>(
  [<span class="cm-string">"####################################################"</span>,
   <span class="cm-string">"#                 ####         ****              ###"</span>,
   <span class="cm-string">"#   *  @  ##                 ########       OO    ##"</span>,
   <span class="cm-string">"#   *    ##        O O                 ****       *#"</span>,
   <span class="cm-string">"#       ##*                        ##########     *#"</span>,
   <span class="cm-string">"#      ##***  *         ****                     **#"</span>,
   <span class="cm-string">"#* **  #  *  ***      #########                  **#"</span>,
   <span class="cm-string">"#* **  #      *               #   *              **#"</span>,
   <span class="cm-string">"#     ##              #   O   #  ***          ######"</span>,
   <span class="cm-string">"#*            @       #       #   *        O  #    #"</span>,
   <span class="cm-string">"#*                    #  ######                 ** #"</span>,
   <span class="cm-string">"###          ****          ***                  ** #"</span>,
   <span class="cm-string">"#       O                        @         O       #"</span>,
   <span class="cm-string">"#   *     ##  ##  ##  ##               ###      *  #"</span>,
   <span class="cm-string">"#   **         #              *       #####  O     #"</span>,
   <span class="cm-string">"##  **  O   O  #  #    ***  ***        ###      ** #"</span>,
   <span class="cm-string">"###               #   *****                    ****#"</span>,
   <span class="cm-string">"####################################################"</span>],
  {<span class="cm-string cm-property">"#"</span>: <span class="cm-variable">Wall</span>,
   <span class="cm-string cm-property">"@"</span>: <span class="cm-variable">Tiger</span>,
   <span class="cm-string cm-property">"O"</span>: <span class="cm-variable">SmartPlantEater</span>, <span class="cm-comment">// from previous exercise</span>
   <span class="cm-string cm-property">"*"</span>: <span class="cm-variable">Plant</span>}
));</pre>
<div class=solution><div class=solution-text>
<p><a class=p_ident id="p_/WrVho3Vwk" href="#p_/WrVho3Vwk"></a>Muchos de los mismos trucos que trabajaron para el ejercicio anterior también se aplican aquí. Se recomienda hacer que los depredadores sean grandes (mucha energía) y que se reproduzcan lentamente. Eso los hará menos vulnerables a los períodos de hambre cuando los herbívoros son escasos.</p>
<p><a class=p_ident id="p_peTHaSk90P" href="#p_peTHaSk90P"></a>Más allá de mantenerse vivo, mantener vivo su alimento es el principal objetivo de un depredador. Encuentre alguna manera de hacer que los depredadores cazan de manera más agresiva cuando hay muchos herbívoros y cazan más lentamente (o no) cuando la presa es rara. Dado que los comedores de plantas se mueven, el simple truco de comer uno solo cuando otros están cerca no es probable que funcione, eso sucederá tan rara vez que su depredador se muera de hambre. Pero usted podría seguir la pista de observaciones en vueltas anteriores, en una cierta estructura de datos guardada en los objetos del depredador, y tenerla basar su comportamiento (<em>behavior</em>) en lo que ha visto recientemente.</p>
</div></div>
<nav>
  <a href="06_object.html" title="capítulo previo">◀</a>
  <a href="index.html" title="cover">◆</a>
  <a href="08_error.html" title="capítulo siguiente">▶</a>
</nav>
</article>
